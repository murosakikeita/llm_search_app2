import streamlit as st
from dotenv import load_dotenv
import logging
import traceback
import utils
from initialize import initialize
import constants as ct

# ----------------------------------------------------
# Streamlitè¨­å®š
# ----------------------------------------------------
st.set_page_config(page_title="ç¤¾å†…æƒ…å ±ç‰¹åŒ–å‹ç”ŸæˆAIæ¤œç´¢ã‚¢ãƒ—ãƒª", layout="wide")
load_dotenv()

logger = logging.getLogger(__name__)

# ----------------------------------------------------
# ã‚¿ã‚¤ãƒˆãƒ«
# ----------------------------------------------------
st.title("ç¤¾å†…æƒ…å ±ç‰¹åŒ–å‹ç”ŸæˆAIæ¤œç´¢ã‚¢ãƒ—ãƒª")

# ----------------------------------------------------
# ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ
# ----------------------------------------------------
mode = st.radio("æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„", ["ç¤¾å†…æ–‡æ›¸æ¤œç´¢", "ç¤¾å†…å•ã„åˆã‚ã›"])

# ----------------------------------------------------
# ã‚¢ãƒ—ãƒªèª¬æ˜
# ----------------------------------------------------
st.markdown("""
ğŸŸ  ã“ã‚“ã«ã¡ã¯ã€‚ç§ã¯ç¤¾å†…æ–‡æ›¸ã®æƒ…å ±ã‚’ã‚‚ã¨ã«å›ç­”ã™ã‚‹ç”ŸæˆAIãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã§ã™ã€‚  
ä¸Šè¨˜ã§åˆ©ç”¨ç›®çš„ã‚’é¸æŠã—ã€ç”»é¢ä¸‹éƒ¨ã®ãƒãƒ£ãƒƒãƒˆæ¬„ã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ãã ã•ã„ã€‚

---

**ã€ã€Œç¤¾å†…æ–‡æ›¸æ¤œç´¢ã€ã‚’é¸æŠã—ãŸå ´åˆã€‘**
> å…¥åŠ›å†…å®¹ã¨é–¢é€£æ€§ãŒé«˜ã„ç¤¾å†…æ–‡æ›¸ã®ã‚ã‚Šã‹ã‚’æ¤œç´¢ã§ãã¾ã™ã€‚  

ğŸ“˜ *å…¥åŠ›ä¾‹*: ã€Œç¤¾å“¡ã®è‚²æˆæ–¹é‡ã«é–¢ã™ã‚‹MTGã®è­°äº‹éŒ²ã€

---

**ã€ã€Œç¤¾å†…å•ã„åˆã‚ã›ã€ã‚’é¸æŠã—ãŸå ´åˆã€‘**
> è³ªå•ãƒ»è¦æœ›ã«å¯¾ã—ã¦ã€ç¤¾å†…æ–‡æ›¸ã®æƒ…å ±ã‚’ã‚‚ã¨ã«å›ç­”ã‚’å¾—ã‚‰ã‚Œã¾ã™ã€‚

ğŸ“— *å…¥åŠ›ä¾‹*: ã€Œäººäº‹éƒ¨ã«æ‰€å±ã—ã¦ã„ã‚‹å¾“æ¥­å“¡æƒ…å ±ã‚’ä¸€è¦§åŒ–ã—ã¦ã€
""")

# ----------------------------------------------------
# åˆæœŸåŒ–å‡¦ç†
# ----------------------------------------------------
try:
    initialize()
except Exception as e:
    st.error("âŒ åˆæœŸåŒ–å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", icon="ğŸš¨")
    st.stop()

# ----------------------------------------------------
# ãƒãƒ£ãƒƒãƒˆå±¥æ­´
# ----------------------------------------------------
if "messages" not in st.session_state:
    st.session_state["messages"] = []

# å®‰å…¨ã«å±¥æ­´ã‚’æç”»
try:
    for msg in st.session_state["messages"]:
        with st.chat_message(msg["role"]):
            st.markdown(msg["content"])
except Exception as e:
    st.error("âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: éå»ã®ä¼šè©±å±¥æ­´ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸã€‚", icon="ğŸš¨")
    traceback.print_exc()

# ----------------------------------------------------
# å…¥åŠ›æ¬„ï¼ˆã“ã‚ŒãŒä¸‹ã«å‡ºã‚‹ï¼ï¼‰
# ----------------------------------------------------
if prompt := st.chat_input("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„"):
    with st.chat_message("user"):
        st.markdown(prompt)
    st.session_state["messages"].append({"role": "user", "content": prompt})

    # ---- ã“ã“ã§ utils ã‹ã‚‰AIå¿œç­”ã‚’ç”Ÿæˆ ----
    try:
        response = utils.generate_answer(prompt, mode)
    except Exception as e:
        response = "âš ï¸ å›ç­”ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
        traceback.print_exc()

    with st.chat_message("assistant"):
        st.markdown(response)
    st.session_state["messages"].append({"role": "assistant", "content": response})
